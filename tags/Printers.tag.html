<app-printers>
    <app-header></app-header>

    <div id="selector">
        <span>Tout</span>
        <label class="switch">
                <input type="checkbox" onclick="{ switch }">
                <span class="slider round"></span>
        </label>
        <span>Disponibles</span>

    </div>

    <div class="content">
        <div each="{ printer in connectedDevices }" if="{ onlyAvailable == false || printer.stateValue == 0}" class="{ printer : true, available : printer.stateValue == 0, unavailable : printer.stateValue == 1, hs : printer.stateValue == -1 }" onclick="{ switchOnDevice(printer.deviceId) }" id="{ printer.deviceId }">
            <div class="core">
                {printer.name}
            </div>
            <div class="footer">
                <virtual if="{ printer.stateValue == -1 }">
                    Hors-Service
                </virtual>

                <virtual if="{ printer.stateValue == 0 }">
                    Disponible
                </virtual>

                <virtual if="{ printer.stateValue == 1 }">
                    Utilisé par { printer.user }
                </virtual>
            </div>
        </div>       

    </div>
    <script>
        var tag = this;

        tag.connectedDevices = null;
        tag.Devices = null;

        tag.onlyAvailable = false;


        tag.on("before-mount", function(){
            if(DEBUG == false)
            {
                ble.scan([],5,function(e){},function(){}); // scan for device during 5 seconds...
                tag.connectedDevices = {};
            }
            else 
            {
                tag.connectedDevices = {
                    
                    "E0:E5:CF:1E:68:87" : 
                    {
                    "deviceId" : "E0:E5:CF:1E:68:87",
                    "name" : "Imprimante démo 1",
                    "stateValue" : 0,
                    },
                    "E0:E5:CF:1E:68:88" : 
                    {
                    "deviceId" : "E0:E5:CF:1E:68:87",
                    "name" : "Imprimante démo 2",
                    "stateValue" : 1,
                    "user" : "Valentin"
                    },
                    "E0:E5:CF:1E:68:6" : 
                    {
                    "deviceId" : "E0:E5:CF:1E:68:87",
                    "name" : "Imprimante démo 2",
                    "stateValue" : -1,
                    }
                };
            }
            var self = tag;
            tag.Devices = {
                "E0:E5:CF:1E:68:87" : new SmartPlug("E0:E5:CF:1E:68:87", "Imprimante 1", false, function(id){ self.updateDevice(id); }, 10, 5)
            };


            tag.initConnexion();
        });


        tag.initConnexion = function () {
            for (var device in tag.Devices)
            {
                device = tag.Devices[device];
                setTimeout(device.connect.bind(device, tag.addDevice), 10000);
            }
        };

        tag.addDevice = function(deviceid)
        {
            tag.connectedDevices[deviceid] = tag.Devices[deviceid];
            tag.update();
        };

        tag.updateDevice = function (deviceId) {
            alert(deviceId+" updated");
            tag.update();
            
        };

        tag.switch = function()
        {
            tag.onlyAvailable = !tag.onlyAvailable;
            tag.update();
        };

        tag.switchOnDevice = function(id){
            return function(event){
                //TODO: gérer la connexion 
                tag.Devices[id].switchOn("Test user");
            }
            
        };

        tag.onError = function (reason) {
                alert("ERROR: " + reason);
        }

    </script>
</app-printers>