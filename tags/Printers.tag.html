<app-printers>
    <app-header></app-header>
    <div class="content">
        <div each="{ printer in connectedDevices }" class="imprimante" onclick="{ switchOnDevice(printer.deviceId) }" id="{ printer.deviceId }">
            <div class="imprimante-carre">
                <div class="imprimante-titre">
                    <img src="image/ultimaker-ii.jpeg" alt="ultimaker" /> {printer.name}
                </div>
                <div class="imprimante-{printer.stateValue}">
                    {printer.stateValue}
                </div>
            </div>
        </div>       

    </div>
    <script>
        var tag = this;

        tag.connectedDevices = null;
        tag.Devices = null;


        tag.on("before-mount", function(){
            ble.scan([],5,function(e){},function(){}); // scan for device during 5 seconds...
            tag.connectedDevices = {};
            var self = tag;
            tag.Devices = {
                "E0:E5:CF:1E:68:87" : new SmartPlug("E0:E5:CF:1E:68:87", "Imprimante 1", false, function(id){ self.updateDevice(id); }, 10, 5)
            };


            tag.initConnexion();
        });

        tag.initConnexion = function () {
            for (var device in tag.Devices)
            {
                device = tag.Devices[device];
                setTimeout(device.connect.bind(device, tag.addDevice), 10000);
            }
        };

        tag.addDevice = function(deviceid)
        {
            tag.connectedDevices[deviceid] = tag.Devices[deviceid];
            tag.update();
        };

        tag.updateDevice = function (deviceId) {
            alert(deviceId+" updated");
            tag.update();
            
        };

        tag.switchOnDevice = function(id){
            return function(event){
                tag.Devices[id].switchOn();
            }
            
        };

        tag.onError = function (reason) {
                alert("ERROR: " + reason);
        }

    </script>
</app-printers>